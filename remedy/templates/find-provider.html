{% extends "base.html" %}

{% block title %}RAD Remedy - Search Providers (Beta!){% endblock %}
{% block head_text %}Search Providers (Beta!){% endblock %}
{% block og_desc %}Find healthcare providers and other resources in RAD's national database.{% endblock %}

{% block head %}
<link href="{{ url_for('static', filename='css/bootstrap-multiselect.css') }}" rel="stylesheet">
<meta name="robots" content="noindex, follow">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% macro render_options(options, cur_values) %}
{# Unpack each option into a (value, label) tuple #}
{%- for optval, optlabel in options %}
  {# If the label isn't a string/number, recurse on it (it's an optgroup) #} 
  {% if optlabel is not string and optlabel is iterable %}
<optgroup label="{{ optval }}">
{{ render_options(optlabel, cur_values) }}
</optgroup>
  {% else %}
<option value="{{ optval }}" {%- if optval in cur_values %} selected="selected"{%- endif %}>{{ optlabel }}</option>
  {% endif %}
{%- endfor %}
{% endmacro %}

{% block content %}
<h2>Find a Provider <small>Beta!</small></h2>

<div class="alert alert-info">
  <div class="media">
    <div class="media-left media-middle hidden-xs hidden-sm">
      <img src="{{ url_for('static', filename='img/betta-launch.png') }}" alt="Theresa, the RAD bet(t)a mascot" />
    </div>
    <div class="media-body">
      <p class="alert-link media-heading">Hey, Listen! This Is a Beta!</p>
      <p>
        We're currently beta-testing this functionality, and so not all of our providers will be in this database yet.
        You can read more at <a href="{{ url_for('remedy.about_the_beta') }}">About the RAD Beta Launch</a>.
      </p>
      <p>
        If you're an individual, you can add providers you know about using our
        <a href="http://goo.gl/forms/T4iXwFUUYp" target="_blank">New Provider Intake form</a>.
      </p>
    </div>
  </div>
</div>

<form role="search" action="{{ url_for('remedy.resource_search') }}" method="GET">
    <div class="form-group">
      <label for="text-search" class="sr-only">
        Search
      </label>
      <input type="text" name="search" id="text-search" value="{{ search_params.get('search', '') }}" 
        class="form-control form-remedy search-remedy" 
        placeholder="Search providers" />
    </div>
    <div class="form-group">
      <div class="input-group">
        <label for="search-addr" class="sr-only">
          Address
        </label>
        <input type="text" name="addr" id="search-addr" value="{{ search_params.get('addr', '') }}" 
          class="form-control form-remedy search-remedy" autocomplete="off"
          placeholder="Address" />
        <span class="input-group-btn">
          <button id="search-loc-lookup" class="btn btn-default" type="button" title="Use my current location">
            <span class="glyphicon glyphicon-screenshot" aria-hidden="true"></span>
            <span class="sr-only">Use my current location</span>
          </button>
        </span>
      </div>
    </div>
    <div class="form-group">
      <label for="search-dist" class="sr-only">
        Distance
      </label>
      <select name="dist" id="search-dist" class="form-control form-remedy search-remedy">
        {# Turn the distance options into tuples and convert the current distance value to a list so we can use render_options #}
        {{ render_options([(-1, 'Anywhere'), (5, '5 miles'), (10, '10 miles'), (25, '25 miles'), (50, '50 miles'), (100, '100 miles'), (200, '200 miles')], [search_params.get('dist', -1)]) }}
      </select>
      <input type="hidden" name="lat" id="search-lat" value="{{ search_params.get('lat', '') }}" />
      <input type="hidden" name="long" id="search-long" value="{{ search_params.get('long', '') }}" />
    </div>

    {% if grouped_categories %}
    <div class="form-group">
      <label for="search-categories">
        Categories
      </label>    
      <select name="categories" id="search-categories" multiple="multiple" 
        data-nounplural="categories" class="form-control form-remedy search-remedy">
        {{ render_options(grouped_categories, search_params.get('categories', [])) }}
      </select>
    </div>
    {% endif %}
    {% if grouped_populations %}
    <div class="form-group">
      <label for="search-populations">
        Populations
      </label>    
      <select name="populations" id="search-populations" multiple="multiple" 
        data-nounplural="populations" class="form-control form-remedy search-remedy">
        {{ render_options(grouped_populations, search_params.get('populations', [])) }}
      </select>
    </div>
    {% endif %}

    <div class="row">
      <div class="form-group">
        <label class="form-control-static col-xs-12">
          Other Options
        </label>
        <div class="col-xs-12 col-sm-6 col-lg-3">
          <label class="checkbox-inline">
            <input type="checkbox" name="icath" value="1"
              {%- if search_params.get('icath', False) %} checked="checked"{%- endif %}>
            Informed Consent/ICATH
          </label>
        </div>
        <div class="col-xs-12 col-sm-6 col-lg-3">
          <label class="checkbox-inline">
            <input type="checkbox" name="wpath" value="1"
              {%- if search_params.get('wpath', False) %} checked="checked"{%- endif %}>
            WPATH Standards of Care
          </label>
        </div>
        <div class="col-xs-12 col-sm-6 col-lg-3">
          <label class="checkbox-inline">
            <input type="checkbox" name="wheelchair_accessible" value="1"
              {%- if search_params.get('wheelchair_accessible', False) %} checked="checked"{%- endif %}>
            ADA/Wheelchair Accessible
          </label>
        </div>
        <div class="col-xs-12 col-sm-6 col-lg-3">
          <label class="checkbox-inline">
            <input type="checkbox" name="sliding_scale" value="1"
              {%- if search_params.get('sliding_scale', False) %} checked="checked"{%- endif %}>
            Sliding Fee Scale
          </label>
        </div>   
      </div>
    </div>
    <hr>
    <button class="btn btn-lg">Search</button>
</form>

<div>
  <section>
    <h2>Results</h2>
    {% if providers %}
    <div class="row">
      <div class="col-md-6">
        {% for r in providers %}
          {{ macros.render_resource(r) }}
        {% endfor %}
        {{ macros.render_pagination(pagination) }}
      </div>
      <div class="col-md-6">
        <div id="provider-map"></div>
      </div>
    </div>
    {% else %}
    <p>
      Don't see what you are looking for? Find out why we may not have any providers in this area at <a href="{{ url_for('remedy.about_the_beta') }}">About the RAD Beta Launch</a>! If you have an excellent provider in this area, you can add them using our <a href="http://goo.gl/forms/T4iXwFUUYp" target="_blank">New Provider Intake form</a>!
    </p>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/bootstrap-multiselect.min.js') }}"></script>
<script type="text/javascript">
  window.Remedy.makeBootstrapMultiselect("search-categories");
  window.Remedy.makeBootstrapMultiselect("search-populations");
  window.Remedy.geoLocationButton('search-loc-lookup', 'search-addr', 'search-lat', 'search-long');
</script>
{{ macros.gmaps_script(false, 'search-addr', 'search-lat', 'search-long') }}
<script type="text/javascript">
  var providers = [];
  {% for r in providers|selectattr("latitude")|selectattr("longitude") %}
  providers.push({
    id: {{ r.id }},
    url: {{ url_for('remedy.resource', resource_id=r.id)|tojson|safe }},
    name: {{ r.name|escape|tojson|safe }},
    desc: {{ r.description|default('', true)|truncate(50)|escape|tojson|safe }},
    address: {{ r.address|default('', true)|escape|tojson|safe }},
    latitude: {{ r.latitude }},
    longitude: {{ r.longitude }},
  });
  {% endfor %}
  window.Remedy.showProviderMap("provider-map", providers);
</script>
{% endblock %}